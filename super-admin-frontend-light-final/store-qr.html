<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>QR المتجر</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="assets/css/style.css" rel="stylesheet"></head>
<body>
<nav class="navbar navbar-expand-lg border-bottom bg-white sticky-top">
  <div class="container-xxl px-3">
    <a class="navbar-brand fw-bold" href="index.html">لوحة السوبر آدمن</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">الرئيسية</a></li>
        <li class="nav-item"><a class="nav-link" href="stores.html">المتاجر</a></li>
        <li class="nav-item"><a class="nav-link" href="ads.html">الإعلانات</a></li>
        <li class="nav-item"><a class="nav-link" href="offers.html">العروض</a></li>
      </ul>
    </div>
  </div>
</nav>
<header class="bg-white border-bottom">
  <div class="container-xxl px-3 py-3"><h1 class="h4 m-0">QR المتجر</h1></div>
</header>
<main class="container-xxl px-3 my-4">
<h5 class="mb-3">🔳 QR المتجر</h5>
<div class="card p-3"><div id="qrPreview" class="qr-box">— QR Preview —</div>
<div class="d-grid gap-2 mt-3"><button class="btn btn-outline-primary" onclick="downloadQR()">⬇️ تنزيل QR</button><button class="btn btn-primary" onclick="startScan()">📷 مسح QR</button></div></div>
<div id="scanSection" class="card p-3 mt-3" style="display:none;">
<h6>مسح الكود QR</h6>
<video id="qrVideo" width="100%" height="auto" style="max-width:320px;"></video>
<canvas id="qrCanvas" style="display:none;"></canvas>
<div id="scanResult" class="mt-3 alert alert-success" style="display:none;"></div>
<div class="d-grid gap-2 mt-3"><button class="btn btn-secondary" onclick="stopScan()">إيقاف المسح</button></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
const params=new URLSearchParams(location.search);const url=params.get('url')||'https://example.com/store/demo';
const box=document.getElementById('qrPreview');box.innerHTML='';const qr=new QRCode(box,{text:url,width:256,height:256});
function downloadQR(){const img=document.querySelector('#qrPreview img, #qrPreview canvas');if(!img)return;
const link=document.createElement('a');link.download='store-qr.png';link.href=img.src||img.toDataURL();link.click();}

let video = document.getElementById('qrVideo');
let canvas = document.getElementById('qrCanvas');
let scanResult = document.getElementById('scanResult');
let scanSection = document.getElementById('scanSection');
let stream;
let scanning = false;

async function startScan() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    video.play();
    scanSection.style.display = 'block';
    scanning = true;
    scanQR();
  } catch (err) {
    alert('خطأ في الوصول إلى الكاميرا: ' + err.message);
  }
}

function stopScan() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  scanning = false;
  scanSection.style.display = 'none';
  scanResult.style.display = 'none';
}

function scanQR() {
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if (code) {
      scanResult.innerHTML = '<strong>النتيجة:</strong> ' + code.data;
      scanResult.style.display = 'block';
      stopScan();
      return;
    }
  }
  requestAnimationFrame(scanQR);
}
</script>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body></html>